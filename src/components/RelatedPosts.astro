---
import { getCollection } from 'astro:content';
import PostCard from './PostCard.astro';
import type { BlogPost } from '../types';

interface Props {
  currentPost: BlogPost;
  limit?: number;
}

const { currentPost, limit = 3 } = Astro.props;

// åŒã˜ã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯åŒã˜ã‚¿ã‚°ã‚’æŒã¤è¨˜äº‹ã‚’å–å¾—
const allPosts = await getCollection('posts', ({ data }) => data.published);
const relatedPosts = allPosts
  .filter(post => post.id !== currentPost.id)
  .map(post => {
    let score = 0;
    // åŒã˜ã‚«ãƒ†ã‚´ãƒªãªã‚‰ +10ç‚¹
    if (post.data.category === currentPost.data.category) score += 10;
    // å…±é€šã‚¿ã‚°1ã¤ã«ã¤ã +5ç‚¹
    const commonTags = post.data.tags?.filter(tag =>
      currentPost.data.tags?.includes(tag)
    ).length || 0;
    score += commonTags * 5;
    return { post, score };
  })
  .filter(({ score }) => score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, limit)
  .map(({ post }) => post);
---

{relatedPosts.length > 0 && (
  <div class="mt-16">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
      <span>ðŸ”—</span>
      <span>é–¢é€£è¨˜äº‹</span>
    </h2>
    <div class="grid gap-6">
      {relatedPosts.map(post => (
        <PostCard post={post} />
      ))}
    </div>
  </div>
)}
