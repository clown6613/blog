---
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { CATEGORIES } from '../../constants/categories';
import { calculateReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => data.published);
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: sortedPosts[index + 1] || null,
      nextPost: sortedPosts[index - 1] || null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;

if (!post) {
  return Astro.redirect('/404');
}

// éå…¬é–‹è¨˜äº‹ã¯404ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
if (!post.data.published) {
  return Astro.redirect('/404');
}

const { Content, headings } = await post.render();
const category = CATEGORIES[post.data.category];
const formattedDate = format(post.data.pubDate, 'yyyyå¹´MMæœˆddæ—¥', { locale: ja });
const readingTime = calculateReadingTime(post.body);
const base = import.meta.env.BASE_URL;
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  type="article"
  publishedTime={post.data.pubDate}
>
  <Header slot="header" />

  <!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="text-sm mb-6">
    <ol class="flex items-center gap-2 text-gray-600 dark:text-gray-400">
      <li><a href={`${base}/`} class="hover:text-primary">ãƒ›ãƒ¼ãƒ </a></li>
      <li>â€º</li>
      <li><a href={`${base}/category/${post.data.category}`} class="hover:text-primary">{CATEGORIES[post.data.category].name}</a></li>
      <li>â€º</li>
      <li class="text-gray-900 dark:text-white font-medium truncate">{post.data.title}</li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- ç›®æ¬¡ -->
    <aside class="lg:col-span-1 order-2 lg:order-1">
      <TableOfContents headings={headings} />
    </aside>

    <!-- è¨˜äº‹æœ¬æ–‡ -->
    <article class="lg:col-span-3 order-1 lg:order-2 prose prose-lg dark:prose-invert max-w-none" data-pagefind-body>
    <!-- è¨˜äº‹ãƒ¡ã‚¿æƒ…å ± -->
    <div class="not-prose mb-8">
      <div class="flex items-center gap-3 mb-4">
        <a
          href={`${base}/category/${post.data.category}`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
        >
          <span class="text-xl">{category.icon}</span>
          <span class="font-medium text-gray-900 dark:text-white">{category.name}</span>
        </a>
        <time class="text-gray-600 dark:text-gray-400" data-pagefind-meta="date">
          {formattedDate}
        </time>
        <span class="text-gray-400 dark:text-gray-500">â€¢</span>
        <span class="text-gray-600 dark:text-gray-400">ğŸ“– ç´„{readingTime}åˆ†</span>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4" data-pagefind-meta="title">
        {post.data.title}
      </h1>

      {post.data.description && (
        <p class="text-xl text-gray-600 dark:text-gray-400">
          {post.data.description}
        </p>
      )}

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-6" data-pagefind-meta="tags">
          {post.data.tags.map(tag => (
            <a
              href={`${base}/tags/${encodeURIComponent(tag)}`}
              class="px-3 py-1 bg-primary/10 text-primary hover:bg-primary/20 text-sm rounded-full transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      )}
    </div>

    <hr class="my-8 border-gray-200 dark:border-gray-700" />

      <!-- è¨˜äº‹æœ¬æ–‡ -->
      <div class="markdown-content">
        <Content />
      </div>
    </article>
  </div>

  <!-- é–¢é€£è¨˜äº‹ -->
  <RelatedPosts currentPost={post} />

  <!-- å‰ã®è¨˜äº‹ãƒ»æ¬¡ã®è¨˜äº‹ -->
  <nav class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {prevPost && (
        <a
          href={`${base}/posts/${prevPost.id}`}
          class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary hover:shadow-md transition-all group"
        >
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">â† å‰ã®è¨˜äº‹</div>
          <div class="font-medium text-gray-900 dark:text-white group-hover:text-primary transition-colors">
            {prevPost.data.title}
          </div>
        </a>
      )}
      {nextPost && (
        <a
          href={`${base}/posts/${nextPost.id}`}
          class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary hover:shadow-md transition-all group md:text-right"
        >
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">æ¬¡ã®è¨˜äº‹ â†’</div>
          <div class="font-medium text-gray-900 dark:text-white group-hover:text-primary transition-colors">
            {nextPost.data.title}
          </div>
        </a>
      )}
    </div>
  </nav>

  <Footer slot="footer" />
</BaseLayout>

<style is:global>
  /* Markdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
  .prose {
    @apply text-gray-800 dark:text-gray-200;
  }

  .prose h1, .prose h2, .prose h3, .prose h4 {
    @apply text-gray-900 dark:text-white font-bold;
  }

  .prose a {
    @apply text-primary hover:underline;
  }

  .prose code {
    @apply bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm;
  }

  .prose pre {
    @apply bg-gray-900 dark:bg-black rounded-lg p-4 overflow-x-auto;
  }

  .prose pre code {
    @apply bg-transparent p-0;
  }

  .prose ul, .prose ol {
    @apply ml-6;
  }

  .prose li {
    @apply my-2;
  }

  .prose blockquote {
    @apply border-l-4 border-gray-300 dark:border-gray-600 pl-4 italic text-gray-700 dark:text-gray-400;
  }

  .prose img {
    @apply rounded-lg shadow-md;
  }
</style>
