---
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { CATEGORIES } from '../../constants/categories';
import { calculateReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => data.published);
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      prevPost: sortedPosts[index + 1] || null,
      nextPost: sortedPosts[index - 1] || null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;

if (!post) {
  return Astro.redirect('/404');
}

// ÈùûÂÖ¨ÈñãË®ò‰∫ã„ÅØ404„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
if (!post.data.published) {
  return Astro.redirect('/404');
}

const { Content, headings } = await post.render();
const category = CATEGORIES[post.data.category];
const formattedDate = format(post.data.pubDate, 'yyyyÂπ¥MMÊúàddÊó•', { locale: ja });
const readingTime = calculateReadingTime(post.body);
const base = import.meta.env.BASE_URL;
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  type="article"
  publishedTime={post.data.pubDate}
>
  <Header slot="header" />

  <!-- „Éë„É≥„Åè„Åö„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
  <nav class="text-xs md:text-sm mb-4 md:mb-6 overflow-x-auto">
    <ol class="flex items-center gap-2 text-gray-600 dark:text-gray-400 whitespace-nowrap">
      <li><a href={`${base}/`} class="hover:text-primary">„Éõ„Éº„É†</a></li>
      <li>‚Ä∫</li>
      <li><a href={`${base}/category/${post.data.category}`} class="hover:text-primary">{CATEGORIES[post.data.category].name}</a></li>
      <li>‚Ä∫</li>
      <li class="text-gray-900 dark:text-white font-medium truncate max-w-[200px] md:max-w-none">{post.data.title}</li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 md:gap-8">
    <!-- ÁõÆÊ¨° -->
    <aside class="lg:col-span-1 order-2 lg:order-1">
      <TableOfContents headings={headings} />
    </aside>

    <!-- Ë®ò‰∫ãÊú¨Êñá -->
    <article class="lg:col-span-3 order-1 lg:order-2 prose prose-lg dark:prose-invert max-w-none" data-pagefind-body>
    <!-- Ë®ò‰∫ã„É°„ÇøÊÉÖÂ†± -->
    <div class="not-prose mb-8">
      <div class="flex items-center gap-3 mb-4">
        <a
          href={`${base}/category/${post.data.category}`}
          class="inline-flex items-center gap-2 px-3 md:px-4 py-1.5 md:py-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm md:text-base"
        >
          <span class="text-lg md:text-xl">{category.icon}</span>
          <span class="font-medium text-gray-900 dark:text-white">{category.name}</span>
        </a>
        <time class="text-gray-600 dark:text-gray-400 text-xs md:text-sm" data-pagefind-meta="date">
          {formattedDate}
        </time>
        <span class="text-gray-400 dark:text-gray-500 hidden sm:inline">‚Ä¢</span>
        <span class="text-gray-600 dark:text-gray-400 text-xs md:text-sm hidden sm:inline">üìñ Á¥Ñ{readingTime}ÂàÜ</span>
      </div>

      <h1 class="text-2xl md:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-primary-light mb-3 md:mb-4 leading-tight" data-pagefind-meta="title">
        {post.data.title}
      </h1>

      {post.data.description && (
        <p class="text-base md:text-xl text-gray-600 dark:text-gray-400">
          {post.data.description}
        </p>
      )}

      {post.data.tags && post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4 md:mt-6" data-pagefind-meta="tags">
          {post.data.tags.map(tag => (
            <a
              href={`${base}/tags/${encodeURIComponent(tag)}`}
              class="px-2 md:px-3 py-1 bg-primary/10 text-primary hover:bg-primary/20 text-xs md:text-sm rounded-full transition-colors"
            >
              #{tag}
            </a>
          ))}
        </div>
      )}
    </div>

    <hr class="my-8 border-gray-200 dark:border-gray-700" />

      <!-- Ë®ò‰∫ãÊú¨Êñá -->
      <div class="markdown-content">
        <Content />
      </div>
    </article>
  </div>

  <!-- Èñ¢ÈÄ£Ë®ò‰∫ã -->
  <RelatedPosts currentPost={post} />

  <!-- Ââç„ÅÆË®ò‰∫ã„ÉªÊ¨°„ÅÆË®ò‰∫ã -->
  <nav class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {prevPost && (
        <a
          href={`${base}/posts/${prevPost.id}`}
          class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary hover:shadow-md transition-all group"
        >
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">‚Üê Ââç„ÅÆË®ò‰∫ã</div>
          <div class="font-medium text-gray-900 dark:text-white group-hover:text-primary transition-colors">
            {prevPost.data.title}
          </div>
        </a>
      )}
      {nextPost && (
        <a
          href={`${base}/posts/${nextPost.id}`}
          class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary hover:shadow-md transition-all group md:text-right"
        >
          <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Ê¨°„ÅÆË®ò‰∫ã ‚Üí</div>
          <div class="font-medium text-gray-900 dark:text-white group-hover:text-primary transition-colors">
            {nextPost.data.title}
          </div>
        </a>
      )}
    </div>
  </nav>

  <Footer slot="footer" />
</BaseLayout>

<style is:global>
  /* Markdown„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„Çπ„Çø„Ç§„É™„É≥„Ç∞ */
  .prose {
    @apply text-gray-700 dark:text-gray-400;
  }

  .prose h1, .prose h2, .prose h3, .prose h4 {
    @apply text-gray-900 dark:text-gray-200 font-bold;
  }

  .prose a {
    @apply text-primary dark:text-primary-light hover:underline;
  }

  .prose code {
    @apply bg-gray-100 dark:bg-slate-700 px-1 py-0.5 rounded text-sm text-primary dark:text-primary-light;
  }

  .prose pre {
    @apply bg-gray-900 dark:bg-slate-950 rounded-lg p-4 overflow-x-auto border border-gray-700 dark:border-primary-dark;
  }

  .prose pre code {
    @apply bg-transparent p-0 text-gray-100;
  }

  .prose ul, .prose ol {
    @apply ml-6;
  }

  .prose li {
    @apply my-2;
  }

  .prose blockquote {
    @apply border-l-4 border-primary dark:border-primary-light pl-4 italic text-gray-700 dark:text-gray-400 bg-gray-50 dark:bg-slate-800 py-2;
  }

  .prose img {
    @apply rounded-lg shadow-md;
  }

  .prose strong {
    @apply text-gray-900 dark:text-gray-100 font-bold;
  }
</style>
