---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');

  // すべてのタグを抽出
  const allTags = new Set<string>();
  allPosts.forEach(post => {
    post.data.tags?.forEach(tag => allTags.add(tag));
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

// タグに該当する公開記事を取得
const posts = (await getCollection('posts', ({ data }) => {
  return data.published === true && data.tags?.includes(tag as string);
})).sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BaseLayout title={`#${tag} - My Blog`}>
  <Header slot="header" />

  <div class="space-y-8">
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
        #{tag}
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {posts.length}件の記事
      </p>
    </div>

    <div class="grid gap-6 md:gap-8">
      {posts.map(post => (
        <PostCard post={post} />
      ))}
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>
